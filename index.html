<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Store ‚Äì BNPL Experiment</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{ --radius:14px; }
  body{ font-family:Inter,system-ui,-apple-system,Segoe UI,Arial,sans-serif }
  .card{ border:1px solid #f1f1f1; border-radius:var(--radius); background:#fff }
  .shadow-smooth{ box-shadow:0 8px 28px rgba(0,0,0,.06) }
</style>
</head>
<body class="bg-gray-50 text-gray-900">

<!-- Header -->
<header class="w-full py-8 px-6 bg-white border-b border-gray-100">
  <div class="max-w-7xl mx-auto flex justify-between items-center">
    <h1 class="text-3xl tracking-tight">Store</h1>
    <button id="checkoutTop" class="relative p-2 rounded-full hover:bg-gray-50" aria-label="Open checkout">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l3-8H6.4M7 13L5.4 5M7 13l-2 9m12-9l2 9M10 21a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z"/>
      </svg>
      <span id="cartBadge" class="hidden absolute -top-1 -right-1 bg-gray-900 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
    </button>
  </div>
</header>

<!-- LANDING -->
<section id="landing" class="min-h-screen">
  <div class="bg-blue-50 border-b border-blue-100">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <p class="text-center text-blue-900">
        Please imagine you are shopping online. Review the products on this page and add any items you would like to your cart. You won't be able to open individual product pages. Once ready, continue to checkout.
      </p>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-6 py-12">
    <div class="mb-12">
      <h2 class="text-4xl tracking-tight mb-4">Featured Products</h2>
      <p class="text-xl text-gray-600 max-w-2xl">Discover our carefully curated selection of premium products designed for modern living.</p>
    </div>

    <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-8 mb-12"></div>

    <div id="checkoutCtaWrap" class="text-center hidden">
      <button id="proceedBtn"
        class="bg-gray-900 hover:bg-gray-800 text-white rounded-full px-8 py-4 text-lg transition-colors">
        Proceed to Checkout
      </button>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-100 py-12">
    <div class="max-w-7xl mx-auto px-6">
      <p class="text-center text-gray-500">¬© 2025 Store. All rights reserved.</p>
    </div>
  </footer>
</section>

<!-- CHECKOUT -->
<section id="checkout" class="hidden min-h-screen bg-gray-50">
  <div class="bg-blue-50 border-b border-blue-100">
    <div class="max-w-4xl mx-auto px-6 py-4">
      <p class="text-center text-blue-900">Please choose the payment method you would most likely use. Note that no card/bank information will be asked/collected from you. Simply select your preferred method of payment.</p>
    </div>
  </div>

  <div class="max-w-4xl mx-auto px-6 py-12">
    <div class="mb-8">
      <button id="backBtn" class="text-gray-600 hover:text-gray-900 p-0 h-auto">‚Üê Back to Products</button>
    </div>

    <div class="grid lg:grid-cols-2 gap-12">
      <!-- order summary -->
      <div>
        <h2 class="text-2xl tracking-tight mb-6">Order Summary</h2>
        <div class="card p-6 mb-6">
          <div id="orderItems" class="divide-y divide-gray-100"></div>
          <div class="mt-6 pt-6 border-t border-gray-100 space-y-3 text-gray-700">
            <div class="flex justify-between"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
            <div class="flex justify-between"><span>Shipping</span><span id="shipping">$9.99</span></div>
            <div class="flex justify-between text-xl pt-3 border-t border-gray-100">
              <span>Total</span><span id="total" class="font-semibold">$9.99</span>
            </div>
          </div>
        </div>
      </div>

      <!-- payment -->
      <div>
        <h2 class="text-2xl tracking-tight mb-6">Payment</h2>
        <div class="card p-6 mb-6">
          <h3 class="text-lg mb-4">Payment Method</h3>

          <label class="flex items-center gap-3 p-4 rounded-xl border border-gray-200 hover:border-gray-300 transition-colors">
            <input type="radio" name="pay" value="card" class="w-4 h-4" checked>
            <div class="flex items-center gap-3">
              <div class="w-8 h-6 bg-gray-100 rounded flex items-center justify-center"><span class="text-xs text-gray-600">üí≥</span></div>
              <span>Credit / Debit Card</span>
            </div>
          </label>

          <label class="mt-4 flex items-center gap-3 p-4 rounded-xl border border-gray-200 hover:border-gray-300 transition-colors">
            <input type="radio" name="pay" value="paypal" class="w-4 h-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-6 bg-blue-100 rounded flex items-center justify-center"><span class="text-xs">PP</span></div>
              <span>PayPal</span>
            </div>
          </label>

          <!-- BNPL option with dynamic price -->
          <label id="bnplRow" class="hidden mt-4 flex items-center gap-3 p-4 rounded-xl border border-gray-200 hover:border-gray-300 transition-colors">
            <input type="radio" name="pay" value="bnpl" class="w-4 h-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-6 bg-purple-100 rounded flex items-center justify-center"><span class="text-xs">BNPL</span></div>
              <span>
                Pay in 4 interest-free installments of
                <strong id="bnplPrice">$0.00</strong>
                <span class="text-gray-500"> (total <span id="bnplTotal">$0.00</span>)</span>
                <button id="bnplInfoBtn" class="inline text-gray-500" title="No interest if paid on time. Late fees may apply.">‚ÑπÔ∏è</button>
              </span>
            </div>
          </label>
        </div>

        <button id="placeBtn" class="w-full bg-gray-900 hover:bg-gray-800 text-white rounded-full py-4 text-lg transition-colors">
          Place Order
        </button>
        <p class="text-center text-gray-500 mt-4">Your payment information is secure and encrypted</p>
      </div>
    </div>
  </div>
</section>

<script>
/* ==================== CONFIG ==================== */
const QUALTRICS_URL = "https://mcgillmgmt.az1.qualtrics.com/jfe/form/SV_dmuuCk1GLKruA98";
const SHIPPING = 9.99;

// Condition: control | checkout_bnpl | product_and_checkout
const params = new URLSearchParams(location.search);
let CONDITION = params.get("cond");
if(!CONDITION){
  const options = ["control","checkout_bnpl","product_and_checkout"];
  CONDITION = options[Math.floor(Math.random()*options.length)];
}
const WORKER_ID = params.get("workerId") || "unknown";

/* ==================== DATA ==================== */
const PRODUCTS = [
  {id:"1", name:"Backpack",   price:49.99,  image:"https://images.unsplash.com/photo-1591534577302-1696205bb2bc?auto=format&fit=crop&w=800&q=80"},
  {id:"2", name:"Sneakers",   price:129.99, image:"https://images.unsplash.com/photo-1573875133340-0b589f59a8c4?auto=format&fit=crop&w=800&q=80"},
  {id:"3", name:"Headphones", price:199.99, image:"https://images.unsplash.com/photo-1632200004922-bc18602c79fc?auto=format&fit=crop&w=800&q=80"},
  {id:"4", name:"Smartwatch", price:249.99, image:"https://images.unsplash.com/photo-1579721840641-7d0e67f1204e?auto=format&fit=crop&w=800&q=80"},
  {id:"5", name:"Jacket",     price:99.99,  image:"https://images.unsplash.com/photo-1617032869698-583c00770254?auto=format&fit=crop&w=800&q=80"}
];

/* ==================== STATE (telemetry) ==================== */
const cart = new Map(); // id -> {id,name,price,image,quantity}
const clicks = { add:0, remove:0, checkoutBtn:0, placeOrder:0, bnplInfo:0, paymentChanges:0, backClicks:0 };
const t0 = performance.now();
let firstClickMs = null;

// exposures & timers
const sawBnplOnProduct = (CONDITION === "product_and_checkout") ? 1 : 0;
let sawBnplOnCheckout = 0;
let reachedCheckout = 0;
let viewProductsMs = 0;
let viewCheckoutMs = 0;
let lastSection = "landing";
let lastSectionStart = performance.now();
let landingScrollMaxPct = 0;

// device info (coarse, non-PII)
const viewport_w = window.innerWidth || document.documentElement.clientWidth;
const ua = navigator.userAgent || "";
const ua_family = /Chrome|Edg|Firefox|Safari/i.exec(ua)?.[0] || "Other";
const device_type = viewport_w < 768 ? "mobile" : (viewport_w < 1024 ? "tablet" : "desktop");

const $ = sel => document.querySelector(sel);
const fmt = n => `$${n.toFixed(2)}`;
const qtr = n => `$${(n/4).toFixed(2)}`;

function onClickLog(key){
  clicks[key]=(clicks[key]||0)+1;
  if(firstClickMs===null) firstClickMs=Math.round(performance.now()-t0);
  updateBadges();
}
function updateBadges(){
  const count = [...cart.values()].reduce((s,i)=>s+i.quantity,0);
  const badge = $("#cartBadge");
  badge.textContent = count;
  badge.classList.toggle("hidden", count===0);
  $("#checkoutCtaWrap").classList.toggle("hidden", count===0);
}

// track landing scroll depth
document.addEventListener('scroll', () => {
  if (lastSection !== "landing") return;
  const doc = document.documentElement;
  const scrolled = (doc.scrollTop || document.body.scrollTop);
  const height = doc.scrollHeight - doc.clientHeight;
  const pct = height > 0 ? Math.round((scrolled / height) * 100) : 0;
  if (pct > landingScrollMaxPct) landingScrollMaxPct = pct;
}, { passive:true });

/* ==================== LANDING ==================== */
function renderGrid(){
  const root = $("#productGrid");
  root.innerHTML = "";
  PRODUCTS.forEach(p=>{
    const item = cart.get(p.id);
    const qty = item ? item.quantity : 0;
    root.insertAdjacentHTML("beforeend", `
      <div class="group card overflow-hidden hover:shadow-smooth transition-all duration-300 hover:-translate-y-1">
        <div class="aspect-square overflow-hidden bg-gray-50">
          <img src="${p.image}" alt="${p.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
        </div>
        <div class="p-6 space-y-4">
          <div class="space-y-2">
            <h3 class="text-lg tracking-tight">${p.name}</h3>
            <p class="text-2xl">${fmt(p.price)}</p>
            ${CONDITION === "product_and_checkout"
              ? `<p class="text-sm text-gray-600 mt-1">
                   or 4 payments of ${qtr(p.price)}
                   <button class="inline text-gray-500" title="No interest if paid on time. Late fees may apply."
                           onclick="clicks.bnplInfo++;event.stopPropagation();">‚ÑπÔ∏è</button>
                 </p>`
              : ``}
          </div>
          <div class="space-y-2">
            <button data-action="add" data-id="${p.id}" class="w-full bg-gray-900 hover:bg-gray-800 text-white rounded-full py-2">
              ${qty>0 ? "Add Another" : "Add to Cart"}
            </button>
            ${qty>0 ? `
              <div class="flex items-center justify-between text-sm text-gray-600">
                <span>In Cart: ${qty}</span>
                <button data-action="remove" data-id="${p.id}" class="text-red-600 hover:underline">Remove One</button>
              </div>` : ``}
          </div>
        </div>
      </div>
    `);
  });
  root.querySelectorAll("button[data-action]").forEach(btn=>{
    btn.onclick = (e)=>{
      const id = e.currentTarget.getAttribute("data-id");
      const action = e.currentTarget.getAttribute("data-action");
      const product = PRODUCTS.find(x=>x.id===id);
      if(action==="add"){
        const existing = cart.get(id);
        if(existing){ existing.quantity += 1; }
        else { cart.set(id, {...product, quantity:1}); }
        onClickLog("add");
      } else if(action==="remove"){
        const existing = cart.get(id);
        if(existing){
          existing.quantity -= 1;
          if(existing.quantity<=0) cart.delete(id);
          onClickLog("remove");
        }
      }
      renderGrid();
      updateBadges();
    };
  });
}

/* ==================== SECTION TIMERS ==================== */
function switchSection(to){
  const now = performance.now();
  if (lastSection === "landing")  viewProductsMs += (now - lastSectionStart);
  if (lastSection === "checkout") viewCheckoutMs += (now - lastSectionStart);
  lastSection = to;
  lastSectionStart = now;
}

/* ==================== CHECKOUT ==================== */
function openCheckout(){
  if(cart.size===0){ return; }
  onClickLog("checkoutBtn");
  reachedCheckout = 1;
  switchSection("checkout");

  // Build order summary
  const itemsRoot = $("#orderItems");
  itemsRoot.innerHTML = "";
  let subtotal = 0;
  cart.forEach(item=>{
    const line = item.price * item.quantity;
    subtotal += line;
    itemsRoot.insertAdjacentHTML("beforeend", `
      <div class="flex items-center gap-4 py-4">
        <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-50 flex-shrink-0">
          <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
        </div>
        <div class="flex-1">
          <h4>${item.name}</h4>
          <p class="text-gray-600">Qty: ${item.quantity}</p>
        </div>
        <div class="text-right"><p>${fmt(line)}</p></div>
      </div>
    `);
  });

  $("#subtotal").textContent = fmt(subtotal);
  const grand = subtotal + SHIPPING;
  $("#total").textContent    = fmt(grand);

  // Toggle BNPL visibility by condition
  const showBnpl = (CONDITION === "checkout_bnpl" || CONDITION === "product_and_checkout");
  document.getElementById("bnplRow").classList.toggle("hidden", !showBnpl);
  sawBnplOnCheckout = showBnpl ? 1 : 0;

  // BNPL dynamic price
  const bnplPriceEl = document.getElementById("bnplPrice");
  const bnplTotalEl = document.getElementById("bnplTotal");
  if (bnplPriceEl && bnplTotalEl) {
    bnplPriceEl.textContent = fmt(grand / 4);
    bnplTotalEl.textContent = fmt(grand);
  }

  // switch sections
  document.getElementById("landing").classList.add("hidden");
  document.getElementById("checkout").classList.remove("hidden");

  // BNPL info click at checkout
  const infoBtn = document.getElementById("bnplInfoBtn");
  if (infoBtn) infoBtn.onclick = () => { clicks.bnplInfo++; };
}

function backToProducts(){
  clicks.backClicks++;
  switchSection("landing");
  document.getElementById("checkout").classList.add("hidden");
  document.getElementById("landing").classList.remove("hidden");
}

function placeOrder(){
  // finalize timers
  switchSection("landing");

  const pay = document.querySelector('input[name="pay"]:checked')?.value || "none";
  clicks.placeOrder++;

  // basket numbers
  const itemsCount = [...cart.values()].reduce((s,i)=>s+i.quantity,0);
  const subtotal   = [...cart.values()].reduce((s,i)=>s+i.quantity*i.price,0);
  const orderTotal = subtotal + SHIPPING;
  const maxPrice   = [...cart.values()].reduce((m,i)=>Math.max(m,i.price),0);
  const priceTier  = orderTotal < 75 ? "low" : (orderTotal <= 175 ? "mid" : "high");
  const bnplInstallment = orderTotal/4;

  const totalMs = Math.round(performance.now()-t0);

  const q = new URLSearchParams({
    // original fields (backward compatible with your Qualtrics ED list)
    workerId: WORKER_ID,
    condition: CONDITION,
    cart_size: String(itemsCount),
    chose_pay: pay,
    addClicks: String(clicks.add),
    removeClicks: String(clicks.remove),
    checkoutClicks: String(clicks.checkoutBtn),
    bnplInfoClicks: String(clicks.bnplInfo),
    firstClickMs: String(firstClickMs ?? ""),
    totalMs: String(totalMs),
    // new fields (for richer analysis)
    variant: CONDITION,
    saw_bnpl_on_product: String(sawBnplOnProduct),
    saw_bnpl_on_checkout: String(sawBnplOnCheckout),
    reached_checkout: String(reachedCheckout),
    view_products_ms: String(Math.round(viewProductsMs)),
    view_checkout_ms: String(Math.round(viewCheckoutMs)),
    scroll_depth_products: String(landingScrollMaxPct),
    items_count: String(itemsCount),
    subtotal_usd: subtotal.toFixed(2),
    shipping_usd: SHIPPING.toFixed(2),
    order_total_usd: orderTotal.toFixed(2),
    max_item_price_usd: maxPrice.toFixed(2),
    price_tier: priceTier,
    bnpl_installment_usd: bnplInstallment.toFixed(2),
    payment_selection_changes: String(clicks.paymentChanges),
    device_type,
    viewport_w: String(viewport_w),
    ua_family,
    order_completed: "1"
  });
  location.href = QUALTRICS_URL + (QUALTRICS_URL.includes("?")?"&":"?") + q.toString();
}

/* ==================== INIT ==================== */
renderGrid(); updateBadges();

// header/cart & nav
document.getElementById("checkoutTop").onclick = openCheckout;
document.getElementById("proceedBtn").onclick  = openCheckout;
document.getElementById("backBtn").onclick     = backToProducts;
document.getElementById("placeBtn").onclick    = placeOrder;

// payment selection change counter
document.addEventListener('change', (e) => {
  if (e.target && e.target.name === 'pay') { clicks.paymentChanges++; }
});
</script>
</body>
</html>
